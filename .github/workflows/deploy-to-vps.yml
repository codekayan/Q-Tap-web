name: CI/CD Pipeline

on:
  push:
    branches: [main, master]

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Validate - Catch errors early
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: ðŸ” Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Validate JSON files
        run: |
          echo "ðŸ” Validating JSON files..."
          for file in messages/*.json; do
            echo "  Checking $file"
            node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))" || exit 1
          done
          echo "âœ… All JSON files are valid!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Deploy to VPS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ðŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            cd /var/www/Q-Tap-web
            
            echo "ðŸ‘‰ Fetching latest code..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ðŸ‘‰ Cleaning everything..."
            rm -rf .next
            rm -rf node_modules
            rm -f package-lock.json
            npm cache clean --force
            
            echo "ðŸ‘‰ Installing dependencies (fresh)..."
            npm install --force
            
            echo "ðŸ‘‰ Building Next.js app..."
            npm run build
            
            echo "ðŸ‘‰ Restarting PM2..."
            pm2 stop qtap-frontend 2>/dev/null || true
            pm2 delete qtap-frontend 2>/dev/null || true
            pm2 start npm --name "qtap-frontend" -- run start
            pm2 save
            
            echo "ðŸ‘‰ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "âœ… Deployed successfully!"
